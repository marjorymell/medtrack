import { View, FlatList, ActivityIndicator, RefreshControl, Pressable } from 'react-native';
import { Text } from '@/components/ui/text';
import { MedicationCard } from '@/components/medication-card';
import { useTodayMedications } from '@/hooks/use-today-medications';
import { useThemeColors } from '@/hooks/use-theme-colors';
import { showToast } from '@/utils/toast';
import { useState, useCallback, useEffect } from 'react';
import { Bell, CheckCircle, Clock, AlertCircle, TrendingUp } from 'lucide-react-native';
import { useRouter } from 'expo-router';
import { useFocusEffect } from '@react-navigation/native';
import { useNotificationSync } from '@/hooks/use-notification-sync';
import { useNotification } from '@/contexts/notification-context';
import { TodayMedication } from '@/types';

const HomeTitleHeader = ({ onNotificationPress }: { onNotificationPress: () => void }) => {
  const colors = useThemeColors();

  return (
    <View className="relative items-center justify-center px-6 pb-4 pt-12">
      <Text className="text-lg font-bold text-foreground dark:text-foreground-dark">
        Medicamentos de Hoje
      </Text>
      <Pressable
        className="absolute right-6 items-center justify-center"
        style={{ top: 48 }}
        onPress={onNotificationPress}>
        <Bell size={24} color={colors.textPrimary} />
      </Pressable>
    </View>
  );
};

const TodayStats = ({ medications }: { medications: any[] }) => {
  const taken = medications.filter((med) => med.status === 'confirmed').length;
  const total = medications.length;
  const pending = total - taken;
  const adherence = total > 0 ? Math.round((taken / total) * 100) : 0;

  return (
    <View className="mx-4 mb-4 rounded-lg bg-card p-4 dark:bg-card-dark">
      <View className="mb-3 flex-row items-center gap-2">
        <TrendingUp size={20} color="#10b981" />
        <Text className="text-lg font-semibold text-foreground dark:text-foreground-dark">
          Resumo do Dia
        </Text>
      </View>

      <View className="flex-row justify-between">
        <View className="items-center">
          <Text className="text-2xl font-bold text-green-600 dark:text-green-400">{taken}</Text>
          <Text className="text-sm text-muted-foreground dark:text-muted-foreground-dark">
            Tomados
          </Text>
        </View>

        <View className="items-center">
          <Text className="text-2xl font-bold text-orange-600 dark:text-orange-400">{pending}</Text>
          <Text className="text-sm text-muted-foreground dark:text-muted-foreground-dark">
            Pendentes
          </Text>
        </View>

        <View className="items-center">
          <Text className="text-2xl font-bold text-blue-600 dark:text-blue-400">{adherence}%</Text>
          <Text className="text-sm text-muted-foreground dark:text-muted-foreground-dark">
            Aderência
          </Text>
        </View>
      </View>
    </View>
  );
};

export default function HomeScreen() {
  const colors = useThemeColors();
  const router = useRouter();

  const { syncNotifications, postponeNotification } = useNotificationSync();

  const { medications, isLoading, error, refetch, confirmMedication, postponeMedication } =
    useTodayMedications();

  const [refreshing, setRefreshing] = useState(false);

  const activeMedications = medications.filter(
    (med: any) =>
      med.status === 'pending' || med.status === 'confirmed' || med.status === 'postponed'
  );

  useFocusEffect(
    useCallback(() => {
      refetch();
    }, [refetch])
  );

  useEffect(() => {
    syncNotifications();
  }, []);

  const handleRefresh = async () => {
    setRefreshing(true);
    await Promise.all([
      refetch(),
      syncNotifications()
    ])
    setRefreshing(false);
  };

  const handleNotificationPress = () => {
    router.push('/notification-settings' as any);
  };

  const handleConfirm = async (scheduleId: string) => {
    try {
      await confirmMedication(scheduleId);
      showToast('Medicamento confirmado com sucesso!', 'success');
    } catch (error) {
      showToast('Erro ao confirmar medicamento', 'error');
    }
  };

  const handlePostpone = async (scheduleId: string, currentScheduledTime: string, medication: TodayMedication) => {
    try {
      const scheduledDate = new Date(currentScheduledTime);
      const postponedDate = new Date(scheduledDate.getTime() + 30 * 60 * 1000); // +30 minutos

      postponeNotification(scheduleId, medication.name, medication.dosage, 30);
      await postponeMedication(scheduleId, 30, postponedDate.toISOString());
      showToast('Medicamento adiado por 30 minutos', 'success');
    } catch (error) {
      showToast('Erro ao adiar medicamento', 'error');
    }
  };

  if (isLoading && !refreshing) {
    return (
      <View className="flex-1 items-center justify-center bg-background dark:bg-background-dark">
        <ActivityIndicator size="large" color={colors.primary} />
        <Text className="mt-4 text-muted-foreground dark:text-muted-foreground-dark">
          Carregando medicamentos...
        </Text>
      </View>
    );
  }

  if (error) {
    return (
      <View className="flex-1 items-center justify-center bg-background px-4 dark:bg-background-dark">
        <AlertCircle size={48} color="#ef4444" className="mb-4" />
        <Text className="mb-4 text-center text-muted-foreground dark:text-muted-foreground-dark">
          {error}
        </Text>
        <Pressable
          onPress={() => refetch()}
          className="rounded-lg bg-primary px-6 py-3 dark:bg-primary-dark">
          <Text className="font-bold text-primary-foreground dark:text-primary-foreground-dark">
            Tentar Novamente
          </Text>
        </Pressable>
      </View>
    );
  }

  return (
    <View className="flex-1 bg-background dark:bg-background-dark">
      <HomeTitleHeader onNotificationPress={handleNotificationPress} />

      <FlatList
        data={activeMedications}
        keyExtractor={(item) => item.scheduleId}
        renderItem={({ item }) => (
          <MedicationCard medication={item} onConfirm={handleConfirm} onPostpone={handlePostpone} />
        )}
        refreshControl={
          <RefreshControl
            refreshing={refreshing}
            onRefresh={handleRefresh}
            tintColor={colors.primary}
          />
        }
        ListHeaderComponent={
          activeMedications.length > 0 ? <TodayStats medications={activeMedications} /> : null
        }
        ListEmptyComponent={
          <View className="flex-1 items-center justify-center py-20">
            <CheckCircle size={48} color="#10b981" className="mb-4" />
            <Text className="mb-2 text-center text-lg font-semibold text-foreground dark:text-foreground-dark">
              Nenhum medicamento pendente!
            </Text>
            <Text className="text-center text-muted-foreground dark:text-muted-foreground-dark">
              Todos os medicamentos de hoje foram tomados ou não há nenhum programado.
            </Text>
          </View>
        }
        contentContainerStyle={{
          flexGrow: 1,
          paddingBottom: 20,
        }}
      />
    </View>
  );
}
